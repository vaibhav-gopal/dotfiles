# https://taskfile.dev

version: '3'

vars:
  USER_NIX_DIR: "$HOME/.config/nix"
  USER_NIX_CONF: "$HOME/.config/nix/nix.conf"
  DOTFILES_NIX_CONF: "{{.TASKFILE_DIR}}/nix.conf"

tasks:
  default:
    aliases: [init]
    desc: Initialize setup for base nix + home-manager setup
    prompt: Do you want to initialize setup for base nix + home-manager setup?
    deps: [up]
    cmds:
      - task: link
  up:
    desc: Update all flake inputs
    cmds:
      - nix flake update
  link:
    desc: Symlink the nix.conf to the official if it exists
    run: when_Changed
    preconditions: # requirements
      - sh: test -f {{.DOTFILES_NIX_CONF}}
        msg: '{{.DOTFILES_NIX_CONF}} must exist before linking step'
      - sh: ! test -fL {{.USER_NIX_CONF}}
        msg: '{{.USER_NIX_CONF}} already exists!'
    status: # status
      - test -d {{.USER_NIX_DIR}}
      - test -fL {{.USER_NIX_CONF}}
    cmds:
      - mkdir -p {{.USER_NIX_DIR}}
      - ln -hs {{.DOTFILES_NIX_CONF}} {{.USER_NIX_CONF}}
  cleanlink:
    desc: Clean the symlink created to nix.conf if created
    run: when_changed
    preconditions: # requirements
      - sh: test -fL {{.USER_NIX_CONF}}
        msg: '{{.USER_NIX_CONF}} is NOT a symlink to remove.'
    cmds:
      - rm {{.USER_NIX_CONF}}